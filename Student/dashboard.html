<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VLUTaskMate - Quản lý Dự án</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>VLUTaskMate</h1>
        <p>Quản lý Dự án của bạn</p>
    </header>
    <nav>
        <a href="dashboard.html">Dự án của tôi</a>
        <a href="profile.html">Profile</a>
        <a href="index.html">Đăng xuất</a>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Dự án đang tham gia</h2>
            <button class="btn" id="createProjectBtn">Tạo nhóm mới</button>
        </div>

        <div id="createProjectModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3>Tạo Nhóm Mới</h3>
                <form id="createProjectForm">
                    <div class="form-group">
                        <label for="newProjectName">Tên dự án:</label>
                        <input type="text" id="newProjectName" name="newProjectName" required>
                    </div>
                    <div class="form-group">
                        <label for="newProjectSubject">Môn học/Dự án ngoài:</label>
                        <input type="text" id="newProjectSubject" name="newProjectSubject">
                    </div>
                    <div class="form-group">
                        <label for="newProjectEndDate">Ngày kết thúc dự kiến:</label>
                        <input type="date" id="newProjectEndDate" name="newProjectEndDate">
                    </div>
                    <div class="form-group">
                        <label for="memberMSSV">Mời thành viên (nhập MSSV):</label>
                        <div class="member-invite-group">
                            <input type="text" id="memberMSSV" name="memberMSSV" 
                                   placeholder="Ví dụ: 217CA12345">
                            <button type="button" class="btn" id="addMemberBtn">Mời</button>
                        </div>
                        <small style="color: #666;">Thành viên sẽ nhận được lời mời tham gia trong trang Profile của họ.</small>
                        <div id="invitedMembersList" style="margin-top: 10px;">
                            <p><strong>Thành viên đã mời:</strong></p>
                            <ul id="membersAdded"></ul>
                        </div>
                    </div>
                    <button type="submit" class="btn">Tạo nhóm</button>
                </form>
            </div>
        </div>

        <div id="editProjectModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3>Chỉnh sửa thông tin nhóm</h3>
                <form id="editProjectForm">
                    <input type="hidden" id="editProjectId"> <div class="form-group">
                        <label for="editProjectName">Tên dự án:</label>
                        <input type="text" id="editProjectName" name="editProjectName" required>
                    </div>
                    <div class="form-group">
                        <label for="editProjectSubject">Môn học/Dự án ngoài:</label>
                        <input type="text" id="editProjectSubject" name="editProjectSubject">
                    </div>
                    <div class="form-group">
                        <label for="editProjectDescription">Mô tả dự án:</label>
                        <textarea id="editProjectDescription" name="editProjectDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editProjectEndDate">Ngày kết thúc dự kiến:</label>
                        <input type="date" id="editProjectEndDate" name="editProjectEndDate">
                    </div>
                    <div class="form-group">
                        <label>Thành viên hiện tại:</label>
                        <ul id="editProjectMembersList">
                            </ul>
                        <div class="member-invite-group" style="margin-top: 10px;">
                            <input type="text" id="editMemberMSSV" placeholder="MSSV thành viên mới">
                            <button type="button" class="btn" id="addEditMemberBtn">Thêm</button>
                        </div>
                    </div>
                    <button type="submit" class="btn">Lưu thay đổi</button>
                </form>
            </div>
        </div>

        <div id="projectList">
            <div class="card" data-project-id="1" 
                 data-project-name="Thiết kế Website E-commerce" 
                 data-project-subject="Thiết kế Web Nâng cao" 
                 data-project-enddate="2025-08-15"
                 data-project-description="Xây dựng một website thương mại điện tử hoàn chỉnh với các chức năng mua sắm, quản lý giỏ hàng, thanh toán và quản lý sản phẩm."
                 data-project-members="Nguyễn Văn A,Trần Thị B,Lê Đình C,Phạm Thu D">
                <h3>Thiết kế Website E-commerce</h3>
                <p><strong>Môn học:</strong> Thiết kế Web Nâng cao</p>
                <p><strong>Ngày kết thúc dự kiến:</strong> 15/08/2025</p>
                <p><strong>Trạng thái:</strong> Đang tiến hành</p>
                <div class="action-buttons">
                    <a href="project-detail.html" class="btn">Xem chi tiết</a>
                    <button class="btn btn-edit edit-project-btn">Chỉnh sửa</button>
                    <button class="btn btn-delete delete-project-btn">Xóa</button>
                </div>
            </div>

            <div class="card" data-project-id="2" 
                 data-project-name="Nghiên cứu Thị trường Game Mobile" 
                 data-project-subject="Dự án ngoài: Đối tác XYZ" 
                 data-project-enddate="2025-07-30"
                 data-project-description="Tiến hành nghiên cứu thị trường và phân tích xu hướng game mobile."
                 data-project-members="Nguyễn Văn A,Trần Thị B">
                <h3>Nghiên cứu Thị trường Game Mobile</h3>
                <p><strong>Dự án ngoài:</strong> Đối tác XYZ</p>
                <p><strong>Ngày kết thúc dự kiến:</strong> 30/07/2025</p>
                <p><strong>Trạng thái:</strong> Đang tiến hành</p>
                <div class="action-buttons">
                    <a href="project-detail.html" class="btn">Xem chi tiết</a>
                    <button class="btn btn-edit edit-project-btn">Chỉnh sửa</button>
                    <button class="btn btn-delete delete-project-btn">Xóa</button>
                </div>
            </div>

            <div class="card" data-project-id="3" 
                 data-project-name="Phân tích Dữ liệu Big Data" 
                 data-project-subject="Khoa học Dữ liệu" 
                 data-project-status="completed"
                 data-project-members="Lê Đình C,Phạm Thu D">
                <h3>Phân tích Dữ liệu Big Data</h3>
                <p><strong>Môn học:</strong> Khoa học Dữ liệu</p>
                <p><strong>Trạng thái:</strong> Đã hoàn thành</p>
                <div class="action-buttons">
                    <a href="project-detail.html" class="btn">Xem chi tiết</a>
                    <a href="evaluation.html" class="btn" style="background-color: #28a745;">Đánh giá dự án</a>
                    <button class="btn btn-edit edit-project-btn">Chỉnh sửa</button>
                    <button class="btn btn-delete delete-project-btn">Xóa</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Common Modal Functions ---
        function openModal(modalId) {
            document.getElementById(modalId).style.display = "block";
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = "none";
        }

        // --- Create Project Modal Logic ---
        var createProjectModal = document.getElementById("createProjectModal");
        var createProjectBtn = document.getElementById("createProjectBtn");
        var closeCreateProjectModalSpan = createProjectModal.getElementsByClassName("close-button")[0];
        var createProjectForm = document.getElementById("createProjectForm");
        var membersAddedList = document.getElementById("membersAdded");
        var addMemberBtn = document.getElementById("addMemberBtn");
        var memberMSSVInput = document.getElementById("memberMSSV");
        var projectListContainer = document.getElementById("projectList");

        // Temporary array to hold members for the new project
        var newProjectMembers = [];

        createProjectBtn.onclick = function() {
            openModal("createProjectModal");
            createProjectForm.reset();
            membersAddedList.innerHTML = ''; // Clear previous members
            newProjectMembers = []; // Reset members array
        }

        closeCreateProjectModalSpan.onclick = function() {
            closeModal("createProjectModal");
        }

        addMemberBtn.onclick = function() {
            var mssv = memberMSSVInput.value.trim();
            if (mssv && !newProjectMembers.includes(mssv)) { // Check for duplicates
                newProjectMembers.push(mssv);
                var listItem = document.createElement("li");
                listItem.textContent = mssv; 
                
                var removeBtn = document.createElement("button");
                removeBtn.textContent = "Xóa";
                removeBtn.className = "btn-delete-small"; 
                removeBtn.onclick = function() {
                    newProjectMembers = newProjectMembers.filter(member => member !== mssv); // Remove from array
                    membersAddedList.removeChild(listItem);
                };
                listItem.appendChild(removeBtn);

                membersAddedList.appendChild(listItem);
                memberMSSVInput.value = '';
            }
        };

        createProjectForm.onsubmit = function(e) {
            e.preventDefault();
            var projectName = document.getElementById("newProjectName").value;
            var projectSubject = document.getElementById("newProjectSubject").value;
            var projectEndDate = document.getElementById("newProjectEndDate").value;
            var projectId = Date.now(); // Simple unique ID for prototype

            if (projectName) {
                var newProjectCard = document.createElement("div");
                newProjectCard.className = "card";
                newProjectCard.setAttribute('data-project-id', projectId);
                newProjectCard.setAttribute('data-project-name', projectName);
                newProjectCard.setAttribute('data-project-subject', projectSubject);
                newProjectCard.setAttribute('data-project-enddate', projectEndDate);
                newProjectCard.setAttribute('data-project-description', ''); // Default empty description
                newProjectCard.setAttribute('data-project-members', newProjectMembers.join(',')); // Store members as comma-separated string

                newProjectCard.innerHTML = `
                    <h3>${projectName}</h3>
                    <p><strong>Môn học:</strong> ${projectSubject}</p>
                    ${projectEndDate ? '<p><strong>Ngày kết thúc dự kiến:</strong> ' + formatDate(projectEndDate) + '</p>' : ''}
                    <p><strong>Trạng thái:</strong> Đang tiến hành</p>
                    <div class="action-buttons">
                        <a href="project-detail.html" class="btn">Xem chi tiết</a>
                        <button class="btn btn-edit edit-project-btn">Chỉnh sửa</button>
                        <button class="btn btn-delete delete-project-btn">Xóa</button>
                    </div>
                `;
                projectListContainer.appendChild(newProjectCard);
                attachProjectEventListeners(newProjectCard); // Attach listeners to new project card

                closeModal("createProjectModal");
                this.reset();
            }
        };

        // --- Edit Project Modal Logic ---
        var editProjectModal = document.getElementById("editProjectModal");
        var closeEditProjectModalSpan = editProjectModal.getElementsByClassName("close-button")[0];
        var editProjectForm = document.getElementById("editProjectForm");
        var editProjectMembersList = document.getElementById("editProjectMembersList");
        var addEditMemberBtn = document.getElementById("addEditMemberBtn");
        var editMemberMSSVInput = document.getElementById("editMemberMSSV");
        var currentEditingProject = null; // To store the .card element being edited
        var editingProjectMembers = []; // Temporary array for members in edit mode

        closeEditProjectModalSpan.onclick = function() {
            closeModal("editProjectModal");
        }

        addEditMemberBtn.onclick = function() {
            var mssv = editMemberMSSVInput.value.trim();
            if (mssv && !editingProjectMembers.includes(mssv)) { // Check for duplicates
                editingProjectMembers.push(mssv);
                renderEditProjectMembers(); // Re-render the list
                editMemberMSSVInput.value = '';
            }
        };

        editProjectForm.onsubmit = function(e) {
            e.preventDefault();
            if (currentEditingProject) {
                var newName = document.getElementById("editProjectName").value;
                var newSubject = document.getElementById("editProjectSubject").value;
                var newDescription = document.getElementById("editProjectDescription").value;
                var newEndDate = document.getElementById("editProjectEndDate").value;
                
                // Update data attributes
                currentEditingProject.setAttribute('data-project-name', newName);
                currentEditingProject.setAttribute('data-project-subject', newSubject);
                currentEditingProject.setAttribute('data-project-description', newDescription);
                currentEditingProject.setAttribute('data-project-enddate', newEndDate);
                currentEditingProject.setAttribute('data-project-members', editingProjectMembers.join(','));

                // Update displayed content
                currentEditingProject.querySelector('h3').textContent = newName;
                currentEditingProject.querySelector('p strong').textContent = newSubject; // This assumes first strong is subject
                // Update or create end date paragraph
                let endDateP = currentEditingProject.querySelector('p:nth-of-type(2)'); // Assuming it's the second p tag
                if (newEndDate) {
                    if (!endDateP || !endDateP.textContent.includes('Ngày kết thúc dự kiến')) {
                        endDateP = document.createElement('p');
                        currentEditingProject.insertBefore(endDateP, currentEditingProject.querySelector('.action-buttons')); // Insert before action buttons
                    }
                    endDateP.innerHTML = `<strong>Ngày kết thúc dự kiến:</strong> ${formatDate(newEndDate)}`;
                } else if (endDateP && endDateP.textContent.includes('Ngày kết thúc dự kiến')) {
                    endDateP.remove(); // Remove if no end date
                }
                
                closeModal("editProjectModal");
            }
        };

        // Function to render members in the edit project modal
        function renderEditProjectMembers() {
            editProjectMembersList.innerHTML = '';
            editingProjectMembers.forEach(mssv => {
                var listItem = document.createElement("li");
                listItem.textContent = mssv;
                var removeBtn = document.createElement("button");
                removeBtn.textContent = "Xóa";
                removeBtn.className = "btn-delete-small";
                removeBtn.onclick = function() {
                    editingProjectMembers = editingProjectMembers.filter(member => member !== mssv);
                    renderEditProjectMembers(); // Re-render the list after removal
                };
                listItem.appendChild(removeBtn);
                editProjectMembersList.appendChild(listItem);
            });
        }

        // --- Project Action Listeners ---
        function attachProjectEventListeners(projectCardElement) {
            // Delete button
            projectCardElement.querySelector('.delete-project-btn').onclick = function() {
                if (confirm('Bạn có chắc chắn muốn xóa dự án này?')) {
                    projectCardElement.remove();
                }
            };

            // Edit button
            projectCardElement.querySelector('.edit-project-btn').onclick = function() {
                currentEditingProject = projectCardElement; // Set the project being edited

                // Populate the edit modal with current project data
                document.getElementById("editProjectName").value = projectCardElement.getAttribute('data-project-name');
                document.getElementById("editProjectSubject").value = projectCardElement.getAttribute('data-project-subject');
                document.getElementById("editProjectDescription").value = projectCardElement.getAttribute('data-project-description');
                document.getElementById("editProjectEndDate").value = projectCardElement.getAttribute('data-project-enddate');
                
                // Populate members list for editing
                editingProjectMembers = projectCardElement.getAttribute('data-project-members').split(',').filter(m => m !== ''); // Clear empty strings
                renderEditProjectMembers(); // Display members in the edit modal
                
                openModal("editProjectModal");
            };
        }

        // Attach event listeners to initial projects when page loads
        document.querySelectorAll('#projectList .card').forEach(attachProjectEventListeners);

        // --- Utility functions ---
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        // --- Close modals when clicking outside ---
        window.onclick = function(event) {
            if (event.target == createProjectModal) {
                closeModal("createProjectModal");
            }
            if (event.target == editProjectModal) {
                closeModal("editProjectModal");
            }
        }
    </script>
</body>
</html>